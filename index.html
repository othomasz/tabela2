<!DOCTYPE html>
<html lang="pt-br">
<head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="UTF-8">
    
  <title>Tabela da Graça ;)</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/x-icon" href="images/favicon.ico">
  <link rel="apple-touch-icon" href="images/icon-192.png">
  <meta name="theme-color" content="#785C47">
</head>
    
<body>
  <h1>Tabela da Graça</h1>
<label for="mes">Mês:</label>
<select id="mes"></select>

<div class="grafico-container">
  <canvas id="graficoPizza"></canvas>
</div>

  <div style="overflow-x: auto; padding-bottom: 8px;">
    <table id="tabela"></table>
  </div>
  <p>
      <a style="padding-right: 8px" href="https://othomasz.github.io/">Página Inicial</a>
      <a href="https://docs.google.com/spreadsheets/d/16EevIxeJqb4657oLH40PoqmKXsolXfj7l4VCBk2LUB8">Planilha</a>
  </p>
  <script>
const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSLBYRao13AJeVkpTtyj-lwqefuQIuVLVchzbERRobSrZ1AwpHh7Cp_KA-QA-f0dNIU1MfV5emaUZua/pub?gid=0&single=true&output=csv';

let dadosPorMes = {};
let grafico;

fetch(url)
  .then(r => r.text())
  .then(csv => {
    const linhas = csv.trim().split('\n').map(l => l.split(','));
    montarTabela(linhas);
    processarDados(linhas);
    montarSelectMes();
  });

function montarTabela(linhas) {
  const tabela = document.getElementById('tabela');

  linhas.forEach((linha, i) => {
    const tr = document.createElement('tr');

    linha.forEach(celula => {
      const el = document.createElement(i === 0 ? 'th' : 'td');
      const v = celula.trim().toLowerCase();

      if (i > 0 && (v === 'true' || v === 'false' || v === 'sim' || v === 'não')) {
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = v === 'true' || v === 'sim';
        cb.disabled = true;
        el.appendChild(cb);
      } else {
        el.textContent = celula;
      }
      tr.appendChild(el);
    });

    tabela.appendChild(tr);
  });
}

function processarDados(linhas) {
  linhas.slice(1).forEach(l => {
    const [data, agua, coca] = l;
    if (!data) return;

    const [dia, mes, ano] = data.split('/');
    const chaveMes = `${mes}/${ano}`;

    if (!dadosPorMes[chaveMes]) {
      dadosPorMes[chaveMes] = { agua: 0, coca: 0, ambos: 0, nenhum: 0 };
    }

    const a = parseInt(agua) || 0;
    const c = parseInt(coca) || 0;

    if (a > 0 && c > 0) dadosPorMes[chaveMes].ambos++;
    else if (a > 0) dadosPorMes[chaveMes].agua++;
    else if (c > 0) dadosPorMes[chaveMes].coca++;
    else dadosPorMes[chaveMes].nenhum++;
  });
}

function montarSelectMes() {
  const select = document.getElementById('mes');

  Object.keys(dadosPorMes).forEach(m => {
    const opt = document.createElement('option');
    opt.value = m;
    opt.textContent = m;
    select.appendChild(opt);
  });

  select.addEventListener('change', () => atualizarGrafico(select.value));
  atualizarGrafico(select.value);
}

function atualizarGrafico(mes) {
  const d = dadosPorMes[mes];

  if (grafico) grafico.destroy();

  grafico = new Chart(document.getElementById('graficoPizza'), {
    type: 'pie',
    data: {
      labels: ['Água', 'Coca', 'Água + Coca', 'Nenhum'],
      datasets: [{
        data: [d.agua, d.coca, d.ambos, d.nenhum],
        backgroundColor: ['#4FC3F7', '#E57373', '#FFD54F', '#BDBDBD']
      }]
    },
    options: {
      plugins: {
        legend: { position: 'bottom' },
        datalabels: {
          formatter: (value, ctx) => {
            const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
            if (!value) return '';
            return `${Math.round(value / total * 100)}%`;
          },
          color: '#000',
          font: { weight: 'bold' }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}
</script>

</body>
</html>
